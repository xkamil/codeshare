<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>codeshare</title>
    <script src="script/codeflas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<a href="/">new snippet</a>
<span id="editor-status"></span>
<div id="editor-frame" class="editor-locked">
    <div id="editor"></div>
</div>
</body>


</html>

<script>
  const room = window.location.pathname.replace("/", "");
  const socket = window.io({query: {room}});
  const editorFrame = document.getElementById('editor-frame');
  const editor = new CodeFlask('#editor', {language: 'js', lineNumbers: true, readonly: true});
  const editorStatus = document.getElementById('editor-status');

  // Socket events

  socket.on('connect', () => {
    getLatestContent();
    updateEditorStatus('connected')
  });

  socket.on('reconnect', () => {
    getLatestContent();
    updateEditorStatus('connected')
  });

  socket.on('content-updated', newContent => {
    updateContent(newContent);
  });

  socket.on('disconnect', () => {
    disableEditMode();
    updateEditorStatus('disconnected')
  });

  socket.on('lock-updated', lockId => {
    if (lockId === socket.id) {
      enableEditMode();
      console.log('lock granted');
    } else {
      disableEditMode();
    }
  });

  // Editor - events

  editorFrame.addEventListener('dblclick', e => {
    socket.emit('acquire-lock');
  })

  editor.onUpdate(newContent => {
    socket.emit('update-content', newContent);
  })

  // Editor - functions

  function enableEditMode() {
    editor.disableReadonlyMode();
    editorFrame.className = 'editor-unlocked';
  }

  function disableEditMode() {
    editor.enableReadonlyMode();
    editorFrame.className = 'editor-locked';
  }

  function updateEditorStatus(newStatus) {
    editorStatus.innerHTML = newStatus;
  }

  function updateContent(newContent){
    editor.code = newContent;
    editor.elTextarea.value = newContent;
    editor.elCode.innerHTML = escapeHtml(newContent);
    editor.highlight();
    editor.setLineNumber();
  }

  const entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;",
    "/": "&#x2F;",
    "`": "&#x60;",
    "=": "&#x3D;"
  };

  function escapeHtml(e) {
    return String(e).replace(/[&<>"'`=/]/g, function (e) {
      return entityMap[e]
    })
  }

  // Api functions

  function getLatestContent() {
    fetch(`/${room}/latestContent`)
      .then(response => response.json())
      .then(latestContent => {
        editor.updateCode(latestContent);
      })
  }



</script>

<style>
    #editor-frame {
        width: 100vw;
        height: 100vh;
        position: relative;
    }

    .editor-locked {
        border: solid 10px #C00;
    }

    .editor-unlocked {
        border: solid 10px #090;
    }
</style>